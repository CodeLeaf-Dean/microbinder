class ObjectHandler{constructor(t){this.mb=t,this.t=this,this.i={},this.h={},this.parentProxy=null}o(t,n,e,r){if("constructor"==t)return null;null==this.h[t]&&(this.h[t]=[]);var i=this.h[t];if(!Array.isArray(i))return null;var s={u:n,l:()=>this.h[t],v:e,p:r};return i.push(s),s}m(t,n,e){if(null!=this.h[t])for(var r=this.h[t].length-1;r>=0;r--)this.h[t][r].u(e,n)}get(t,n,e){if("_proxyHandler"===n)return this;if("_parentProxy"===n)return this.parentProxy;if("_isProxy"===n)return!0;if("_proxyObject"===n)return t;if("_subscribe"===n)return this.o.bind(this);var r=Reflect.get(t,n,e);if(this.mb.g&&(this.mb.$.find((t=>t.handler==this&&t.prop==n))||this.mb.$.push({handler:this,prop:n})),this.mb.A&&this.mb.B.push((t=>e[n]=t)),null!=r&&"object"==typeof r){if(null==this.i[n]){var i=this.mb.wrap(r);i.F.parentProxy=e,i.F.parentProp=n,this.i[n]=i}return this.i[n]}return r}set(t,n,e,r){var i=!1;null!=e&&e.j&&(this.i[n]=e,e=e.C,i=!0);var s=t[n],h=Reflect.set(t,n,e,r);if("object"==typeof e&&!i){var o=this.i[n];if(delete this.i[n],Array.isArray(e)){var u=r[n];o&&(o.length=0,u.F.I=o.F.I),u.F.O(0,0,e.length,u)}}return this.m(n,s,e),h}}class DateHandler extends ObjectHandler{constructor(t){super(t)}get(t,n,e){var r=super.get(t,n,e);return"function"==typeof r?function(n){var e=new Date(t.valueOf()),i=r.apply(t,arguments);return t!=e&&this.parentProxy.F.m(this.parentProp,e,t),i}.bind(this):r}set(t,n,e,r){var i=this.mb.A;this.mb.A=!1;var s=super.set(t,n,e,r);return this.mb.A=i,s}}class BindingContext{constructor(t,n,e,r){this.mb=t,this.$data=n,this.$parentContext=r,this.H=new Proxy({$index:e},new ObjectHandler(t))}get $parent(){return this.$parentContext.$data}get $index(){return this.mb.g&&this.mb.$.push({handler:this.H.proxyHandler,prop:"$index"}),this.H.$index}set $index(t){this.H.$index=t}getPreviousElement(t){if(t.getPreviousSibling){var n=t.getPreviousSibling();if(n&&n.getPreviousSibling){if(n.bindArray&&0!=n.bindArray.length&&0!=n.bindArray[n.bindArray.length-1].length){var e=n.bindArray[n.bindArray.length-1];return e[e.length-1]}return this.getPreviousElement(n)}return n}}}class ArrayHandler extends ObjectHandler{constructor(t,n,e){super(t),this.i=[],this._=[],this.I=[]}O(t,n,e,r){var i=[];i[0]=t,i[1]=n;for(let t=0;t<e;t++)i[t+2]=null;if(Array.prototype.splice.apply(this.i,i),this.I.length>0){let i=this.I[0];i.$array.childContexts.splice(t,n);for(let n=t;n<t+e;n++){const t=r[n];i.$array.childContexts.splice(n,0,new BindingContext(this.mb,t,n,i.$context))}for(let n=t+e;n<i.$array.childContexts.length;n++)i.$array.childContexts[n].$index=n}this.I.forEach((r=>{for(let e=0;e<n;e++)r.bindArray[t+e].forEach((t=>t.remove()));var i=[];i[0]=t,i[1]=n;for(let t=0;t<e;t++)i[t+2]=[];Array.prototype.splice.apply(r.bindArray,i)})),e>0&&this.I.forEach((n=>{var i=document.createDocumentFragment(),s=n.insertFunc;for(let h=t;h<t+e;h++){const t=r[h];s.call(t,n.$array.childContexts[h],i,n)}var h=n.bindArray;if(null==t||t>=h.length)n.appendChild(i);else if(0==t)n.prepend(i);else{var o=(h=n.bindArray[t-1])[h.length-1].nextSibling;n.insertBefore(i,o)}})),this.parentProxy.F.m(this.parentProp,this.parentProxy)}get(t,n,e){var r=super.get(t,n,e);return"childContexts"===n?this._:"function"==typeof r?"splice"===n?function(n){var r=arguments[0];r>t.length&&(r=t.length),r<-t.length&&(r=0),r<0&&(r=t.length+r+1);var i=1==arguments.length?t.length-r:arguments[1];i>t.length-r&&(i=t.length-r);var s=Array.prototype.splice.apply(t,arguments);return this.O(r,i,arguments.length-2,e),s}.bind(this):"push"===n?function(n){var r=t.length,i=Array.prototype.push.apply(t,arguments);return this.O(r,0,arguments.length,e),i}.bind(this):"pop"===n?function(){if(0!=t.length){var n=t.length,r=Array.prototype.pop.apply(t,arguments);return this.O(n-1,1,0,e),r}}.bind(this):"shift"===n?function(){if(0!=t.length){var n=Array.prototype.shift.apply(t,arguments);return this.O(0,1,0,e),n}}.bind(this):"unshift"===n?function(n){var r=Array.prototype.unshift.apply(t,arguments);return this.O(0,0,1,e),r}.bind(this):"reverse"===n||"sort"==n?function(r){var i=Array.prototype[n].apply(t,arguments);return this.O(0,t.length,t.length,e),i}.bind(this):"fill"===n?function(n){var r=arguments[1]||0,i=arguments[2]||t.length;r<0&&(r=ob.length+r),i<0&&(i=ob.length+i);var s=Array.prototype.fill.apply(t,arguments);return this.O(r,i,i-r,e),s}.bind(this):"indexOf"===n?function(n){arguments[0]=this.mb.unwrap(arguments[0]);var e=Array.prototype.indexOf.apply(t,arguments);return e}.bind(this):r.bind(e):r}set(t,n,e,r){var i=t.length,s=Reflect.set(t,n,e,r);return"length"===n?i>e&&this.O(e,i-e):t.length===i?this.O(parseInt(n),1,1,t):this.O(parseInt(n),0,1,t),s}}class MicroBinderCore{constructor(){this.P=1,this.R={},this.g=!1,this.$=[],this.bindObjects=[],this.bindObjectCount=-1}wrap(t){if(t.j)return t;if(null!=t.L)return t.L;var n="[object Date]"===Object.prototype.toString.call(t)?new DateHandler(this):Array.isArray(t)?new ArrayHandler(this,null,t):new ObjectHandler(this),e=new Proxy(t,n);return t.L=e,e}unwrap(t){return t.j?t.C:t}bind(t,n,e,r){this.g=!0,this.$=[];var i=t.call(null==e?null:e.$data);if(this.g=!1,this.$.length>0){var s=this.P++;this.R[s]=[],this.$.forEach((r=>{if(r.handler){var i=r.handler.o(r.prop,((r,i)=>{this.R[s].forEach((t=>t.l().splice(t.l().indexOf(t),1))),delete this.R[s],this.bind(t,n,e,i)}),t,s);i&&this.R[s].push(i)}}))}n(i,arguments.length<4?i:r)}computed(t,n){var e=this,r=e.wrap(n),i=e.wrap({value:void 0});return e.bind(t.bind(r),function(t){i.value!=t&&(i.value=t)}.bind(r)),function(){return i.value}}}class FuncGenerator{constructor(t){this.defaultBinders=[{match:"input[type=text]",binder:"textInput"},{match:"ul",binder:"foreach"},{match:"button",binder:"click"}],this.mb=t}generateRootInsertFunc(t){return new Promise(((n,e)=>{var r=null,i="unnamed-template";if("string"==typeof t){var s=document.getElementById(t);if(null!=s){if("LINK"==s.nodeName){i=s.href;var h=new XMLHttpRequest;return h.open("GET",s.href),h.onreadystatechange=function(){h.readyState===XMLHttpRequest.DONE&&200===h.status&&n(this.buildInsertFuncWithSourceMap(h.responseText,i))}.bind(this),void h.send()}i=t,r=s.content?s.content.cloneNode(!0):document.createRange().createContextualFragment(s.innerHTML)}else{var o=document.createElement("template");o.innerHTML=t,r=o.content}}else r=t;n(null==r?this.buildInsertFuncWithSourceMap(document.body.childNodes,i,!0):this.buildInsertFuncWithSourceMap(r,i))}))}buildInsertFuncWithSourceMap(t,n,e){var r,i={root:[],offset:[]};if("[object NodeList]"===t.toString())r=Array.prototype.reduce.call(t,(function(t,n){return t+(n.outerHTML||n.nodeValue)}),"");else if("string"==typeof t){var s=document.createElement("template");s.innerHTML=t,t=s.content,r=s.innerHTML}else{var h=document.createElement("div");h.appendChild(t.cloneNode(!0)),r=h.innerHTML}var o=[],u=[];this.buildInsertFuncBody(o,u,t,0,r,i,e);var a=o.join("").match(/\n/g).length+3;i.root.length=a;for(let t=0;t<u.length;t++){const n=u[t];o.push("// Offset: ",a),null==i.offset[t]&&(i.offset[t]=[]),i.offset[t].length=(n.code.join("").match(/\n/g)||[]).length,a+=i.offset[t].length,o=o.concat(n.code)}o.push("\n");const c=15,l=31,f=32;function d(t){return t.map(v).map(p).join("")}function v(t){if(0===t)return[0];let n=Math.abs(t);const e=[];for(;n>0;){let r=0;0===e.length?(r=t<0?1:0,r|=(n&c)<<1,n>>>=4):(r=n&l,n>>>=5),n>0&&(r|=f),e.push(r)}return e}function p(t){return t.map((t=>"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[t])).join("")}var b=0;for(let t=0;t<i.root.length;t++){const n=i.root[t];if(null!=n)d([0,0,m=n-b,0]),b+=m;";"}for(let t=0;t<i.offset.length;t++){const n=i.offset[t];for(let t=0;t<n.length;t++){const e=n[t];var m;if(null!=e)d([0,0,m=e-b,0]),b+=m;";"}}var y=new Function("$context,n0,$funcElement",o.join(""));return console.log(y),y}buildInsertFuncBody(t,n,e,r,i,s,h,o){return t.maxDepth=0,t.push("\nvar $mb = $context.mb;\n"),t.push("\nvar t = null;\n"),t.push("\nvar prev = null;\n"),t.push("var renderedElements = [];\n"),"[object NodeList]"===e.toString()?o?e.forEach((e=>this.executeBindingsFuncVisit(e,t,n,1,r,i,s,h))):e.forEach((e=>this.buildInsertFuncVisit(e,t,n,1,r,i,s,h))):o?this.executeBindingsFuncVisit(e,t,n,0,r,i,s,h):this.buildInsertFuncVisit(e,t,n,0,r,i,s,h),t.push("if($funcElement){\n"),t.push("    if(!$funcElement.bindArray)$funcElement.bindArray=[];\n"),t.push("    $funcElement.bindArray[$context.$index || 0] = renderedElements;\n"),t.push("}\n"),t}buildInsertFunc(t,n,e,r,i,s){var h=[];this.buildInsertFuncBody(h,t,n,e,r,i,s);var o=new Function("$context,n0,$funcElement",h.join(""));return console.log(o),o}executeBindingsFuncVisit(t,n,e,r,i,s,h,o){if(1==t.nodeType)t.getAttribute("bind")}buildInsertFuncVisit(t,n,e,r,i,s,h,o){var u=!1;if(1==t.nodeType){if("VIRTUAL"==t.nodeName?(n.push("prev = ","n",r,";\n"),n.push(r>n.maxDepth?"var ":"","n",r," = document.createDocumentFragment();\n"),n.push("n",r,".prev = prev;\n"),n.push("n",r,".parent = ","n",r-1,";\n"),n.push("n",r,".getPreviousSibling = function(){return this.prev};\n")):n.push(r>n.maxDepth?"var ":"","n",r," = document.createElement('",t.nodeName,"');\n"),r>n.maxDepth&&(n.maxDepth=r),t.hasAttributes()){var a=t.attributes;for(let b=a.length-1;b>=0;b--){const m=a[b].name;var c=a[b].value;if("bind"==m){if(-1==c.indexOf(":"))c="{"+this.getDefaultBinder(t)+":"+c+"}";c.startsWith("{")||(c="{"+c+"}");var l={$data:new FunctionTester,$index:()=>0},f=new Function("$context","with($context){with($data){ return "+c+"}}").call(l.$data,l);for(const t in f)c=c.replace(new RegExp(t+"s*:"),t+": ()=> ");u=Object.keys(f).some((t=>Object.keys(this.mb.subBinders).indexOf(t)>=0));var d=i;u&&(this.mb.bindObjects.push(this.buildInsertFunc(e,t.childNodes,this.mb.bindObjects.length+1)),this.mb.bindObjectCount++,d=this.mb.bindObjectCount,e[d]={code:["\n    $mb.bindObjects[",this.mb.bindObjectCount,"] = ",this.buildInsertFunc(e,t.childNodes,this.mb.bindObjectCount,s,h,!0),";\n"]}),n.push("{");var v=0,p=0;if(s)p=(s.substr(0,s.indexOf(t.outerHTML)).match(/\n/g)||[]).length,v=n.join("").match(/\n/g).length+3,o?(null==h.offset[i]&&(h.offset[i]=[]),h.offset[i][v]=p):h.root[v]=p;n.push("$mb.executeBinding(n",r,", $context, (function(){with($context){with($data??{}){\nreturn ",c,"// line: ",v,", offset: ",o,", src: ",p,"\n}}}).call($context.$data), ",d,");\n"),t.nodeName,n.push("}\n")}else"class"==m?n.push("n",r,".classList.add('",c,"');\n"):n.push("n",r,".setAttribute('",m,"', '",c,"');\n")}}"VIRTUAL"==t.nodeName?(r-1==0&&n.push("renderedElements.push.apply(renderedElements, Array.from(n",r,".childNodes));\n\n"),n.push("n",r-1,".appendChild(n",r,");\n\n")):(n.push("n",r-1,".appendChild(n",r,");\n\n"),r-1==0&&n.push("renderedElements.push(n",r,");\n\n"))}else 3==t.nodeType&&(n.push("t = document.createTextNode(`",t.nodeValue.replace(/\\/g,"\\\\"),"`);\n"),n.push("n",r-1,".appendChild(t);\n\n"),r-1==0&&n.push("renderedElements.push(t);\n\n"));u||t.childNodes.forEach((t=>this.buildInsertFuncVisit(t,n,e,r+1,i,s,h,o)))}getDefaultBinder(t){for(let n=0;n<this.defaultBinders.length;n++){const e=this.defaultBinders[n];if(t.matches(e.match))return e.binder}return"text"}}function FunctionTester(){return this.has=function(t,n){return!0},this.get=function(t,n,e){return n==Symbol.unscopables?{}:n==Symbol.toPrimitive||"toString"==n?()=>"":new FunctionTester},this.set=function(t,n,e,r){},this.apply=function(t,n,e){return new FunctionTester},new Proxy((function(){}),this)}function ForBinder(t,n,e,r){t.insertFunc=n.mb.bindObjects[r],t.$context=n,n.mb.bind(e,((e,i)=>{t.insertFunc=n.mb.bindObjects[r],t.$context=n;var s=document.createDocumentFragment();for(let r=0;r<e;r++)t.insertFunc.call(this,new BindingContext(n.mb,n.$data,r,n),s,t);t.appendChild(s)}),n)}function ForEachBinder(t,n,e,r){t.insertFunc=n.mb.bindObjects[r],t.$context=n;var i=e.call(n.$data);t.$array=i,t.bindArray=[],i.F.I.push(t);var s=document.createDocumentFragment();for(let e=0;e<i.length;e++){const r=i[e];null==i.childContexts[e]&&(i.childContexts[e]=new BindingContext(n.mb,r,e,n)),t.insertFunc.call(r,i.childContexts[e],s,t)}t.appendChild(s)}function ComponentBinder(t,n,e,r){var i=e(),s=n.mb.components[i.name];t.$context=n,t.insertFunc=s.insertFunc;var h=document.createDocumentFragment(),o=null==s.viewModel?n.$data:new s.viewModel(n.mb,i.params);o=n.mb.wrap(o);var u=new BindingContext(n.mb,o,0,n);t.insertFunc.call(o,u,h,t),t.appendChild(h)}function IfBinder(t,n,e,r){t.insertFunc=n.mb.bindObjects[r],t.$context=n,t.M=!1,n.mb.bind(e,((e,r)=>{if(e&&!t.M){var i=document.createDocumentFragment();if(t.insertFunc.call(n.$data,n,i,t),t.appendChild(i),t.getPreviousSibling){var s=n.getPreviousElement(t);if(null==s)for(let n=t.children.length-1;n>=0;n--)t.parent.insertAdjacentElement("afterbegin",t.children[n]);else s.after(t)}t.M=!0}else if(!e&&t.M){if(t.getPreviousSibling){var h=t.bindArray[0];for(let t=0;t<h.length;t++)h[t].remove();t.bindArray[0]=[]}else t.innerHTML="";t.M=!1}}))}class MicroBinder extends MicroBinderCore{constructor(){super();var t=this;this.components={register:function(n,e){return this[n]=e,this[n].insertFunc=t.build(e.template).then((t=>{this[n].insertFunc=t})),this[n].insertFunc}},this.funcGen=new FuncGenerator(this),this.binders={text:(t,n,e)=>this.bind(e,((n,e)=>t.innerText=n),n),html:(t,n,e)=>this.bind(e,((n,e)=>t.innerHTML=n),n),value:(t,n,e)=>{this.bind(e,((n,e)=>t.value=n||""),n),t.addEventListener("change",(t=>this.setValue(n,e,t.target.value)))},textInput:(t,n,e)=>{this.bind(e,((n,e)=>t.value=n||""),n),t.addEventListener("input",(t=>this.setValue(n,e,t.target.value)))},checked:(t,n,e)=>{this.bind(e,((n,e)=>{n?t.setAttribute("checked",""):t.removeAttribute("checked","")}),n),t.addEventListener("change",(t=>this.setValue(n,e,t.target.checked)))},hasFocus:(t,n,e)=>{this.bind(e,((n,e)=>n?t.focus():t.blur()),n),t.addEventListener("focus",(t=>this.setValue(n,e,!0))),t.addEventListener("blur",(t=>this.setValue(n,e,!1)))},css:(t,n,e)=>{var r=e();if("string"==typeof r)this.bind(e,((n,e)=>{"string"==typeof e&&e.split(" ").forEach((n=>{""!=n&&t.classList.remove(n)})),n.split(" ").forEach((n=>{""!=n&&t.classList.add(n)}))}),n);else for(const e in r)this.bind(r[e],((n,r)=>n?t.classList.add(e):t.classList.remove(e)),n)},attr:(t,n,e)=>{var r=e();for(const e in r)this.bind(r[e],((n,r)=>t.setAttribute(e,n)),n)},prop:(t,n,e)=>{var r=e(),i=!1;for(const e in r)this.bind(r[e],((n,r)=>{t.proxy[e]!=n&&(i=!0,t.proxy[e]=n,i=!1)}),n);t.addEventListener("propchange",(t=>{null!=e()[t.name]&&0==i&&this.setValue(n,r[t.name],t.newValue)}))},props:(t,n,e)=>{var r=!1;this.bind(e,((n,e)=>{for(const n in e)this.bind(e,(()=>e[n]),((e,i)=>{t.proxy[n]!=e&&(r=!0,t.proxy[n]=e,r=!1)}))}),n),t.addEventListener("propchange",(t=>{var n=e();null!=n[t.name]&&0==r&&this.setValue(n,(()=>n[t.name]),t.newValue)}))},style:(t,n,e)=>{var r=e();for(const e in r)this.bind(r[e],((n,r)=>t.style[e]=n),n)},visible:(t,n,e)=>this.bind(e,((n,e)=>t.style.display=n?null:"none"),n),click:(t,n,e)=>t.addEventListener("click",(t=>e().call(n.$data,n.$data,t))),enter:(t,n,e)=>{t.addEventListener("keypress",(t=>{13===t.keyCode&&e()(n.$data,t)}))},submit:(t,n,e)=>t.addEventListener("submit",(t=>e()(n.$data,t))),if:IfBinder,with:(t,n,e,r)=>{t.insertFunc=this.funcGen.bindObjects[r],t.$context=n,this.bind(e,((e,r)=>{t.innerHTML="";var i=document.createDocumentFragment();t.insertFunc.call(e,new BindingContext(this,e,0,n),i,t),t.appendChild(i)}),n)},for:ForBinder,foreach:ForEachBinder,component:ComponentBinder,selectedOptions:(t,n,e)=>{this.bind(e,((n,e)=>{var r=n.map((t=>t.toString()));Array.from(t.options).forEach((t=>t.selected=r.indexOf(t.value)>-1))}),n),t.addEventListener("change",(t=>{var r=Array.from(t.target.selectedOptions).map((t=>t.value));this.setValue(n,e,r)}))},event:(t,n,e)=>{var r=e();for(const e in r){const i=r[e];t.addEventListener(e,(e=>i.call(n.$data,t,e)))}},enable:(t,n,e)=>{this.bind(e,((n,e)=>n?t.removeAttribute("disabled"):t.setAttribute("disabled","")),n)},disable:(t,n,e)=>{this.bind(e,((n,e)=>n?t.setAttribute("disabled",""):t.removeAttribute("disabled")),n)}},this.subBinders={if:1,with:1,foreach:1,for:1},this.bindObjects=[],this.bindObjectCount=-1}applyBindings(t,n,e){return this.build(e).then((e=>this.run(t,n||document.body,e)))}build(t){return new Promise(((n,e)=>{this.funcGen.generateRootInsertFunc(t).then((t=>{n(t)})).catch((t=>e(t)))}))}run(t,n,e){var r=this.wrap(t),i=new BindingContext(this,r);return e.call(this,i,n),r}executeBinding(t,n,e,r){var i=!1;for(var s in e)i=this.binders[s](t,n,e[s],r)|i;return i}setValue(t,n,e){this.A=!0,this.B=[];n.call(t.$data);this.A=!1,this.B.length>0&&this.B.pop()(e)}}export default MicroBinder;