class MicroBinder{constructor(){this.t=1,this.i={},this.s=!1,this.o=[],this.bindObjects=[],this.bindObjectCount=-1,this.defaultBinders=[{match:"input[type=text]",binder:"textInput"},{match:"ul",binder:"foreach"},{match:"button",binder:"click"}],this.subBinders={if:1,with:1,foreach:1},this.binders={text:(t,e,n)=>mb.bind(e,n,(e,n)=>t.innerText=n),html:(t,e,n)=>mb.bind(e,n,(e,n)=>t.innerHTML=n),value:(t,e,n)=>{mb.bind(e,n,(e,n)=>t.value=n||""),t.addEventListener("change",t=>mb.setValue(e,n,t.target.value))},textInput:(t,e,n)=>{mb.bind(e,n,(e,n)=>t.value=n||""),t.addEventListener("input",t=>mb.setValue(e,n,t.target.value))},checked:(t,e,n)=>{mb.bind(e,n,(e,n)=>{n?t.setAttribute("checked",""):t.removeAttribute("checked","")}),t.addEventListener("change",t=>mb.setValue(e,n,t.target.checked))},hasFocus:(t,e,n)=>{mb.bind(e,n,(e,n)=>n?t.focus():t.blur()),t.addEventListener("focus",t=>mb.setValue(e,n,!0)),t.addEventListener("blur",t=>mb.setValue(e,n,!1))},css:(t,e,n)=>{var r=n();for(const n in r)mb.bind(e,r[n],(e,r)=>r?t.classList.add(n):t.classList.remove(n))},attr:(t,e,n)=>{var r=n();for(const n in r)mb.bind(e,r[n],(e,r)=>t.setAttribute(n,r))},prop:(t,e,n)=>{var r=n(),i=!1;for(const n in r)mb.bind(e,r[n],(e,r)=>{t.proxy[n]!=r&&(i=!0,t.proxy[n]=r,i=!1)});t.addEventListener("propchange",t=>{null!=n()[t.name]&&0==i&&mb.setValue(e,r[t.name],t.newValue)})},props:(t,e,n)=>{var r=!1;mb.bind(e,n,(e,n)=>{for(const e in n)mb.bind(n,()=>n[e],(n,i)=>{t.proxy[e]!=i&&(r=!0,t.proxy[e]=i,r=!1)})}),t.addEventListener("propchange",t=>{var e=n();null!=e[t.name]&&0==r&&mb.setValue(e,()=>e[t.name],t.newValue)})},style:(t,e,n)=>{var r=n();for(const n in r)mb.bind(e,r[n],(e,r)=>t.style[n]=r)},visible:(t,e,n)=>mb.bind(e,n,(e,n)=>t.style.display=n?null:"none"),click:(t,e,n)=>t.addEventListener("click",t=>n()(e.$data,t)),enter:(t,e,n)=>{t.addEventListener("keypress",t=>{13===t.keyCode&&n()(e.$data,t)})},submit:(t,e,n)=>t.addEventListener("submit",t=>n()(e.$data,t)),if:(t,e,n,r)=>{t.insertFunc=this.bindObjects[r],t.$context=e,t.h=!1,mb.bind(e,n,(n,r)=>{if(r&&!t.h){var i=document.createDocumentFragment();t.insertFunc.call(e.$data,e,i,t),t.appendChild(i),t.h=!0}else!r&&t.h&&(t.innerHTML="",t.h=!1)})},with:(t,e,n,r)=>{t.insertFunc=this.bindObjects[r],t.$context=e,mb.bind(e,n,(n,r)=>{t.innerHTML="";var i=document.createDocumentFragment();t.insertFunc.call(r,new BindingContext(r,0,e),i,t),t.appendChild(i)})},foreach:(t,e,n,r)=>{t.insertFunc=this.bindObjects[r],t.$context=e;var i=n.call(e.$data);t.$array=i,t.bindArray=[],i.proxyHandler.u.push(t);var s=document.createDocumentFragment();for(let n=0;n<i.length;n++){const r=i[n];null==i.childContexts[n]&&(i.childContexts[n]=new BindingContext(r,n,e)),t.insertFunc.call(r,i.childContexts[n],s,t)}t.appendChild(s)},selectedOptions:(t,e,n)=>{mb.bind(e,n,(e,n)=>{var r=n.map(t=>t.toString());Array.from(t.options).forEach(t=>t.selected=r.indexOf(t.value)>-1)}),t.addEventListener("change",t=>{var r=Array.from(t.target.selectedOptions).map(t=>t.value);mb.setValue(e,n,r)})},event:(t,e,n)=>{var r=n();for(const n in r){const i=r[n];t.addEventListener(n,n=>i.call(e,t))}},enable:(t,e,n)=>{mb.bind(e,n,(e,n)=>n?t.removeAttribute("disabled"):t.setAttribute("disabled",""))},disable:(t,e,n)=>{mb.bind(e,n,(e,n)=>n?t.setAttribute("disabled",""):t.removeAttribute("disabled"))}}}bind(t,e,n,r){this.s=!0,this.o=[];var i=e.call(t.$data);if(this.s=!1,this.o.length>0){var s=this.t++;this.i[s]=[],this.o.forEach(t=>t.handler.l(t.prop,e,n,s))}n(r,i)}setValue(t,e,n){this.m=!0,this.v=[];e.call(t.$data);this.m=!1,this.v.length>0&&this.v.pop()(n)}executeBinding(t,e,n,r){var i=!1;for(var s in n)i=mb.binders[s](t,e,n[s],r)|i;return i}p(t){for(let e=0;e<this.defaultBinders.length;e++){const n=this.defaultBinders[e];if(t.matches(n.match))return n.binder}return"text"}g(t,e,n,r,i,s,o){return t.maxDepth=0,t.push("\nvar t = null;\n"),t.push("var renderedElements = [];\n"),"[object NodeList]"===n.toString()?n.forEach(n=>this.$(n,t,e,1,r,i,s,o)):this.$(n,t,e,0,r,i,s,o),t.push("if($funcElement){\n"),t.push("    if(!$funcElement.bindArray)$funcElement.bindArray=[];\n"),t.push("    $funcElement.bindArray[$context.$index] = renderedElements;\n"),t.push("}\n"),t}A(t,e,n,r,i,s){var o=[];return this.g(o,t,e,n,r,i,s),new Function("$context,n0,$funcElement",o.join(""))}$(t,e,n,r,i,s,o,a){var h=!1;if(1==t.nodeType){if(e.push(r>e.maxDepth?"var ":"","n",r," = document.createElement('",t.nodeName,"');\n"),r>e.maxDepth&&(e.maxDepth=r),t.hasAttributes()){var c=t.attributes;for(let v=c.length-1;v>=0;v--){const p=c[v].name;var u=c[v].value;if("bind"==p){if(-1==u.indexOf(":"))u="{"+this.p(t)+":"+u+"}";u.startsWith("{")||(u="{"+u+"}");var l={$data:new Proxy((function(){}),new FunctionTester),$index:()=>0},d=new Function("$context","with($context){with($data){ return "+u+"}}").call(l.$data,l);for(const t in d)u=u.replace(new RegExp(t+"s*:"),t+": ()=> ");h=Object.keys(d).some(t=>Object.keys(this.subBinders).indexOf(t)>=0);var f=i;h&&(this.bindObjectCount++,f=this.bindObjectCount,n[this.bindObjectCount]={code:["\n    mb.bindObjects[",this.bindObjectCount,"] = ",this.A(n,t.childNodes,this.bindObjectCount,s,o,!0),";\n"]}),e.push("{");var b=0,m=0;if(s)m=(s.substr(0,s.indexOf(t.outerHTML)).match(/\n/g)??[]).length,b=e.join("").match(/\n/g).length+3,a?(null==o.offset[i]&&(o.offset[i]=[]),o.offset[i][b]=m):o.root[b]=m;e.push("mb.executeBinding(n",r,", $context, (function(){with($context){with($data??{}){\nreturn ",u,"// line: ",b,", offset: ",a,", src: ",m,"\n}}}).call($context.$data), ",f,");\n"),e.push("}")}else e.push("n",r,".setAttribute('",p,"', '",u,"');\n")}}e.push("n",r-1,".appendChild(n",r,");\n\n"),r-1==0&&e.push("renderedElements.push(n",r,");\n\n")}else 3==t.nodeType&&(e.push("t = document.createTextNode(`",t.nodeValue.replace(/\\/g,"\\\\"),"`);\n"),e.push("n",r-1,".appendChild(t);\n\n"),r-1==0&&e.push("renderedElements.push(t);\n\n"));h||t.childNodes.forEach(t=>this.$(t,e,n,r+1,i,s,o,a))}H(t,e){var n,r={root:[],offset:[]};if("[object NodeList]"===t.toString())n=Array.prototype.reduce.call(t,(function(t,e){return t+(e.outerHTML||e.nodeValue)}),"");else if("string"==typeof t){var i=document.createElement("template");i.innerHTML=t,t=i.content,n=i.innerHTML}else{var s=document.createElement("div");s.appendChild(t.cloneNode(!0)),n=s.innerHTML}var o=["function mb_start(){\n"],a=[];this.g(o,a,t,0,n,r),o.push("};");var h=o.join("").match(/\n/g).length+3;r.root.length=h;for(let t=0;t<a.length;t++){const e=a[t];o.push("// Offset: ",h),null==r.offset[t]&&(r.offset[t]=[]),r.offset[t].length=(e.code.join("").match(/\n/g)??[]).length,h+=r.offset[t].length,o=o.concat(e.code)}o.push("\nmb_start();"),o.push("\n"),o.push("//# sourceMappingURL=data:text/plain;base64,");const c=15,u=31,l=32;function d(t){return t.map(f).map(b).join("")}function f(t){if(0===t)return[0];let e=Math.abs(t);const n=[];for(;e>0;){let r=0;0===n.length?(r=t<0?1:0,r|=(e&c)<<1,e>>>=4):(r=e&u,e>>>=5),e>0&&(r|=l),n.push(r)}return n}function b(t){return t.map(t=>"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[t]).join("")}var m="",v=0;for(let t=0;t<r.root.length;t++){const e=r.root[t];if(null!=e)m+=d([0,0,p=e-v,0]),v+=p;m+=";"}for(let t=0;t<r.offset.length;t++){const e=r.offset[t];for(let t=0;t<e.length;t++){const n=e[t];var p;if(null!=n)m+=d([0,0,p=n-v,0]),v+=p;m+=";"}}var x={version:3,sources:[e+".template"],names:[],mappings:m,sourcesContent:[n]};return o.push(btoa(JSON.stringify(x))),o.push("\n"),o.push("//# sourceURL="+e+".template.js"),new Function("$context,n0,$funcElement",o.join(""))}j(t,e){return new Promise((n,r)=>{var i=null,s="microbinder-root-template";if("string"==typeof e){var o=document.getElementById(e);if(null!=o){if("LINK"==o.nodeName){s=o.href;var a=new XMLHttpRequest;return a.open("GET",o.href),a.onreadystatechange=function(){a.readyState===XMLHttpRequest.DONE&&200===a.status&&n(this.H(a.responseText))}.bind(this),void a.send()}s=e,i=o.content?o.content.cloneNode(!0):document.createRange().createContextualFragment(o.innerHTML)}else{var h=document.createElement("template");h.innerHTML=e,i=h.content}}else i=e;null==i&&(i=t||document.body.childNodes),null==t&&(t=document.body),n(this.H(i,s))})}makeProxy(t){return"object"!=typeof t||t.isProxy?t:new Proxy(t,new ObjectHandler)}build(t,e){return new Promise((n,r)=>{this.j(t,e).then(t=>{n(t)}).catch(t=>r(t))})}run(t,e,n){var r=this.makeProxy(t),i=new BindingContext(r);return n.call(r,i,e),r}render(t,e,n){return this.build(e,n).then(n=>this.run(t,e??document.body,n))}}var mb=new MicroBinder;class FunctionTester{has(t,e){return!0}get(t,e,n){return e==Symbol.unscopables?{}:e==Symbol.toPrimitive||"toString"==e?()=>"":n}set(t,e,n,r){}apply(t,e,n){return this}}class ObjectHandler{constructor(){this.C=this,this.O={},this._={},this.parentProxy=null}l(t,e,n,r){null==this._[t]&&(this._[t]=[]);var i={B:()=>this._[t],F:e,k:n,M:r};this._[t].push(i),mb.i[r].push(i)}I(t,e,n,r){if(null!=this._[t]){var i=[];this._[t].forEach(t=>{mb.bind(e,t.F,t.k,n),i.push(t.M)}),i.forEach(t=>{mb.i[t].forEach(t=>t.B().splice(t.B().indexOf(t),1)),delete mb.i[t]})}}get(t,e,n){if("proxyHandler"===e)return this;if("parentProxy"===e)return this.parentProxy;if("isProxy"===e)return!0;if("proxyObject"===e)return t;var r=Reflect.get(t,e,n);if(mb.s&&(mb.o.find(t=>t.handler==this&&t.prop==e)||mb.o.push({handler:this,prop:e})),this instanceof DateHandler||!mb.m||mb.v.push(t=>n[e]=t),null!=r&&"object"==typeof r){if(null==this.O[e]){var i="[object Date]"===Object.prototype.toString.call(r)?new DateHandler:Array.isArray(r)?new ArrayHandler(e,n):new ObjectHandler;i.parentProxy=n,this.O[e]=new Proxy(r,i)}return this.O[e]}return r}set(t,e,n,r){null!=n&&n.isProxy&&(n=n.proxyObject);var i=t[e],s=Reflect.set(t,e,n,r);if("object"==typeof n){var o=this.O[e];if(delete this.O[e],Array.isArray(n)){var a=r[e];o&&(o.length=0,a.proxyHandler.u=o.proxyHandler.u),a.proxyHandler.L(0,0,n.length,a)}}return this.I(e,r,i,n),s}}class DateHandler extends ObjectHandler{constructor(){super()}get(t,e,n){var r=super.get(t,e,n);return"function"==typeof r?function(i){var s=t,o=r.apply(t,arguments);return t!=s&&this.I(e,n,s,o),o}.bind(this):r}set(t,e,n,r){return super.set(t,e,n,r)}}class ArrayHandler extends ObjectHandler{constructor(t,e){super(),this.O=[],this.P=[],this.u=[],this.R=t,this.S=e}L(t,e,n,r){var i=[];i[0]=t,i[1]=e;for(let t=0;t<n;t++)i[t+2]=null;if(Array.prototype.splice.apply(this.O,i),this.u.length>0){let i=this.u[0];i.$array.childContexts.splice(t,e);for(let e=t;e<t+n;e++){const t=r[e];i.$array.childContexts.splice(e,0,new BindingContext(t,e,i.$context))}for(let e=t+n;e<i.$array.childContexts.length;e++)i.$array.childContexts[e].$index=e}this.u.forEach(r=>{for(let n=0;n<e;n++)r.bindArray[t+n].forEach(t=>t.remove());var i=[];i[0]=t,i[1]=e;for(let t=0;t<n;t++)i[t+2]=[];Array.prototype.splice.apply(r.bindArray,i)}),this.u.forEach(e=>{var i=document.createDocumentFragment(),s=e.insertFunc;for(let o=t;o<t+n;o++){const t=r[o];s.call(t,e.$array.childContexts[o],i,e)}var o=e.bindArray;if(null==t||t>=o.length)e.appendChild(i);else if(0==t)e.prepend(i);else{var a=(o=e.bindArray[t-1])[o.length-1].nextSibling;e.insertBefore(i,a)}}),this.S.proxyHandler.I(this.R,this.S)}get(t,e,n){var r=super.get(t,e,n);return"childContexts"===e?this.P:"function"==typeof r?"splice"===e?function(e){var r=arguments[0];r>t.length&&(r=t.length),r<-t.length&&(r=0),r<0&&(r=t.length+r+1);var i=1==arguments.length?t.length-r:arguments[1];i>t.length-r&&(i=t.length-r);var s=Array.prototype.splice.apply(t,arguments);return this.L(r,i,arguments.length-2,n),s}.bind(this):"push"===e?function(e){var r=t.length,i=Array.prototype.push.apply(t,arguments);return this.L(r,0,arguments.length,n),i}.bind(this):"pop"===e?function(){if(0!=t.length){var e=t.length,r=Array.prototype.pop.apply(t,arguments);return this.L(e-1,1,0,n),r}}.bind(this):"shift"===e?function(){if(0!=t.length){var e=Array.prototype.shift.apply(t,arguments);return this.L(0,1,0,n),e}}.bind(this):"unshift"===e?function(e){var r=Array.prototype.unshift.apply(t,arguments);return this.L(0,0,1,n),r}.bind(this):"reverse"===e||"sort"==e?function(r){var i=Array.prototype[e].apply(t,arguments);return this.L(0,t.length,t.length,n),i}.bind(this):"fill"===e?function(e){var r=arguments[1]||0,i=arguments[2]||t.length;r<0&&(r=ob.length+r),i<0&&(i=ob.length+i);var s=Array.prototype.fill.apply(t,arguments);return this.L(r,i,i-r,n),s}.bind(this):r.bind(n):r}set(t,e,n,r){var i=t.length,s=Reflect.set(t,e,n,r);return"length"===e?i>n&&this.L(n,i-n):t.length===i?this.L(parseInt(e),1,1,t):this.L(parseInt(e),0,1,t),s}}class BindingContext{constructor(t,e,n){this.$data=t,this.$parentContext=n,this.T=new Proxy({$index:e},new ObjectHandler)}get $parent(){return this.$parentContext.$data}get $index(){return mb.s&&mb.o.push({handler:this.T.proxyHandler,prop:"$index"}),this.T.$index}set $index(t){this.T.$index=t}}class CustomElementHandler extends ObjectHandler{constructor(){super()}get(t,e,n){var r=super.get(t,e,n);return"function"==typeof r?function(e){var n=r.apply(t,arguments);return n}.bind(this):r}}class MicroBinderHTMLElement extends HTMLElement{constructor(t){super(),this.template=t,this.handlingAttributeChange=!1,this.settingAttribute=!1,this.proxy=new Proxy(this,new CustomElementHandler),this.attributeProperty={},this.attributesBound=!1}useShadow(){this.shadow=this.attachShadow({mode:"open"})}bindAttributes(){this.__proto__.constructor.observedAttributes.forEach(t=>{this.attributeProperty[t]=(()=>{for(const e in this)if(e.toLowerCase()==t)return e})();let e=this.attributeProperty[t];this.proxy[e]=this.getAttribute(t)||this[e],mb.bind(this.proxy,()=>this.proxy[e],(n,r)=>{if(n!=r){this.handlingAttributeChange||(""==r?this.removeAttribute(t):(this.settingAttribute=!0,this.setAttribute(t,r),this.settingAttribute=!1));var i=new Event("propchange");i.name=e,i.newValue=r,this.dispatchEvent(i)}})}),this.attributesBound=!0}disconnectedCallback(){}adoptedCallback(){}connectedCallback(){mb.render(this.proxy,this.shadow?this.shadow:this,this.template),this.__proto__.constructor.observedAttributes&&(this.settingAttribute=!0,this.__proto__.constructor.observedAttributes.forEach(t=>{var e=this[this.attributeProperty[t]];""==e?this.removeAttribute(t):this.setAttribute(t,e)}),this.settingAttribute=!1)}attributeChangedCallback(t,e,n){this.attributesBound&&!this.settingAttribute&&(this.handlingAttributeChange=!0,this.proxy[this.attributeProperty[t]]=n,this.handlingAttributeChange=!1)}}mb.templateClass=function(t){return class extends MicroBinderHTMLElement{constructor(){super(t),this.useShadow()}}};