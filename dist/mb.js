class ObjectHandler{constructor(t){this.mb=t,this.t=this,this.i={},this.h={},this.parentProxy=null}o(t,e,n,r){if("constructor"==t)return null;null==this.h[t]&&(this.h[t]=[]);var i=this.h[t];if(!Array.isArray(i))return null;var s={u:e,l:()=>this.h[t],v:n,p:r};return i.push(s),s}m(t,e,n){if(null!=this.h[t])for(var r=this.h[t].length-1;r>=0;r--)this.h[t][r].u(n,e)}get(t,e,n){if("_proxyHandler"===e)return this;if("_parentProxy"===e)return this.parentProxy;if("_isProxy"===e)return!0;if("_proxyObject"===e)return t;if("_subscribe"===e)return this.o.bind(this);var r=Reflect.get(t,e,n);if(this.mb.g&&(this.mb.$.find((t=>t.handler==this&&t.prop==e))||this.mb.$.push({handler:this,prop:e})),//!(this instanceof DateHandler) && 
this.mb.A&&this.mb.j.push((t=>n[e]=t)),null!=r&&"object"==typeof r){if(null==this.i[e]){var i=this.mb.wrap(r);i.B.parentProxy=n,i.B.parentProp=e,this.i[e]=i}return this.i[e]}return r}set(t,e,n,r){var i=!1;null!=n&&n.F&&(this.i[e]=n,n=n.O,i=!0);var s=t[e],h=Reflect.set(t,e,n,r);if("object"==typeof n&&!i){var a=this.i[e];if(delete this.i[e],Array.isArray(n)){var o=r[e];a&&(a.length=0,o.B._=a.B._),o.B.H(0,0,n.length,o)}}return this.m(e,s,n),h}}class DateHandler extends ObjectHandler{constructor(t){super(t)}get(t,e,n){var r=super.get(t,e,n);return"function"==typeof r?function(e){var n=new Date(t.valueOf()),i=r.apply(t,arguments);return t!=n&&this.parentProxy.B.m(this.parentProp,n,t),i}.bind(this):r}set(t,e,n,r){return super.set(t,e,n,r)}}class ArrayHandler extends ObjectHandler{constructor(t,e,n){super(t),this.i=[],this.C=[],this._=[]}H(t,e,n,r){var i=[];i[0]=t,i[1]=e;for(let t=0;t<n;t++)i[t+2]=null;if(Array.prototype.splice.apply(this.i,i),this._.length>0){let i=this._[0];i.$array.childContexts.splice(t,e);for(let e=t;e<t+n;e++){const t=r[e];i.$array.childContexts.splice(e,0,new BindingContext(this.mb,t,e,i.$context))}for(let e=t+n;e<i.$array.childContexts.length;e++)i.$array.childContexts[e].$index=e}this._.forEach((r=>{for(let n=0;n<e;n++)r.bindArray[t+n].forEach((t=>t.remove()));var i=[];i[0]=t,i[1]=e;for(let t=0;t<n;t++)i[t+2]=[];Array.prototype.splice.apply(r.bindArray,i)})),this._.forEach((e=>{var i=document.createDocumentFragment(),s=e.insertFunc;for(let h=t;h<t+n;h++){const t=r[h];s.call(t,e.$array.childContexts[h],i,e)}var h=e.bindArray;if(null==t||t>=h.length)e.appendChild(i);else if(0==t)e.prepend(i);else{var a=(h=e.bindArray[t-1])[h.length-1].nextSibling;e.insertBefore(i,a)}})),this.parentProxy.B.m(this.parentProp,this.parentProxy)}get(t,e,n){var r=super.get(t,e,n);return"childContexts"===e?this.C:"function"==typeof r?"splice"===e?function(e){var r=arguments[0];r>t.length&&(r=t.length),r<-t.length&&(r=0),r<0&&(r=t.length+r+1);var i=1==arguments.length?t.length-r:arguments[1];i>t.length-r&&(i=t.length-r);var s=Array.prototype.splice.apply(t,arguments);return this.H(r,i,arguments.length-2,n),s}.bind(this):"push"===e?function(e){var r=t.length,i=Array.prototype.push.apply(t,arguments);return this.H(r,0,arguments.length,n),i}.bind(this):"pop"===e?function(){if(0!=t.length){var e=t.length,r=Array.prototype.pop.apply(t,arguments);return this.H(e-1,1,0,n),r}}.bind(this):"shift"===e?function(){if(0!=t.length){var e=Array.prototype.shift.apply(t,arguments);return this.H(0,1,0,n),e}}.bind(this):"unshift"===e?function(e){var r=Array.prototype.unshift.apply(t,arguments);return this.H(0,0,1,n),r}.bind(this):"reverse"===e||"sort"==e?function(r){var i=Array.prototype[e].apply(t,arguments);return this.H(0,t.length,t.length,n),i}.bind(this):"fill"===e?function(e){var r=arguments[1]||0,i=arguments[2]||t.length;r<0&&(r=ob.length+r),i<0&&(i=ob.length+i);var s=Array.prototype.fill.apply(t,arguments);return this.H(r,i,i-r,n),s}.bind(this):r.bind(n):r}set(t,e,n,r){var i=t.length,s=Reflect.set(t,e,n,r);return"length"===e?i>n&&this.H(n,i-n):t.length===i?this.H(parseInt(e),1,1,t):this.H(parseInt(e),0,1,t),s}}class MicroBinderCore{constructor(){this.I=1,this.M={},this.g=!1,this.$=[],this.bindObjects=[],this.bindObjectCount=-1}wrap(t){if(t.F)return t;var e="[object Date]"===Object.prototype.toString.call(t)?new DateHandler(this):Array.isArray(t)?new ArrayHandler(this,null,t):new ObjectHandler(this);return new Proxy(t,e)}unwrap(t){return t.F?t.O:t}bind(t,e,n,r){this.g=!0,this.$=[];var i=t.call(n.$data);if(this.g=!1,this.$.length>0){var s=this.I++;this.M[s]=[],this.$.forEach((r=>{var i=r.handler.o(r.prop,((r,i)=>{this.M[s].forEach((t=>t.l().splice(t.l().indexOf(t),1))),delete this.M[s],this.bind(t,e,n,i)}),t,s);i&&this.M[s].push(i)}))}e(i,arguments.length<4?i:r)}}class BindingContext$1{constructor(t,e,n,r){this.mb=t,this.$data=e,this.$parentContext=r,this.R=new Proxy({$index:n},new ObjectHandler(t))}get $parent(){return this.$parentContext.$data}get $index(){return mb.g&&mb.$.push({handler:this.R.proxyHandler,prop:"$index"}),this.R.$index}set $index(t){this.R.$index=t}}class FuncGenerator{constructor(){this.defaultBinders=[{match:"input[type=text]",binder:"textInput"},{match:"ul",binder:"foreach"},{match:"button",binder:"click"}],this.subBinders={if:1,with:1,foreach:1}}generateRootInsertFunc(t){return new Promise(((e,n)=>{var r=null,i="unnamed-template";if("string"==typeof t){var s=document.getElementById(t);if(null!=s){if("LINK"==s.nodeName){i=s.href;var h=new XMLHttpRequest;return h.open("GET",s.href),h.onreadystatechange=function(){h.readyState===XMLHttpRequest.DONE&&200===h.status&&e(this.buildInsertFuncWithSourceMap(h.responseText,i))}.bind(this),void h.send()}i=t,r=s.content?s.content.cloneNode(!0):document.createRange().createContextualFragment(s.innerHTML)}else{var a=document.createElement("template");a.innerHTML=t,r=a.content}}else r=t;e(null==r?this.buildInsertFuncWithSourceMap(document.body.childNodes,i,!0):this.buildInsertFuncWithSourceMap(r,i))}))}buildInsertFuncWithSourceMap(t,e,n){var r,i={root:[],offset:[]};if("[object NodeList]"===t.toString())r=Array.prototype.reduce.call(t,(function(t,e){return t+(e.outerHTML||e.nodeValue)}),"");else if("string"==typeof t){var s=document.createElement("template");s.innerHTML=t,t=s.content,r=s.innerHTML}else{var h=document.createElement("div");h.appendChild(t.cloneNode(!0)),r=h.innerHTML}var a=[],o=[];this.buildInsertFuncBody(a,o,t,0,r,i,n);var u=a.join("").match(/\n/g).length+3;i.root.length=u;for(let t=0;t<o.length;t++){const e=o[t];a.push("// Offset: ",u),null==i.offset[t]&&(i.offset[t]=[]),i.offset[t].length=(e.code.join("").match(/\n/g)||[]).length,u+=i.offset[t].length,a=a.concat(e.code)}a.push("\n"),a.push("//# sourceMappingURL=data:text/plain;base64,");const c=15,l=31,d=32;function f(t){return t.map(v).map(p).join("")}function v(t){if(0===t)return[0];let e=Math.abs(t);const n=[];for(;e>0;){let r=0;0===n.length?(r=t<0?1:0,r|=(e&c)<<1,e>>>=4):(r=e&l,e>>>=5),e>0&&(r|=d),n.push(r)}return n}function p(t){return t.map((t=>"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[t])).join("")}var b="",m=0;for(let t=0;t<i.root.length;t++){const e=i.root[t];if(null!=e)b+=f([0,0,y=e-m,0]),m+=y;b+=";"}for(let t=0;t<i.offset.length;t++){const e=i.offset[t];for(let t=0;t<e.length;t++){const n=e[t];var y;if(null!=n)b+=f([0,0,y=n-m,0]),m+=y;b+=";"}}var x={version:3,sources:[e+".template"],names:[],mappings:b,sourcesContent:[r]};return a.push(btoa(JSON.stringify(x))),a.push("\n"),a.push("//# sourceURL="+e+".template.js"),new Function("$context,n0,$funcElement",a.join(""))}buildInsertFuncBody(t,e,n,r,i,s,h,a){return t.maxDepth=0,t.push("\nvar $mb = this;\n"),t.push("\nvar t = null;\n"),t.push("var renderedElements = [];\n"),"[object NodeList]"===n.toString()?a?n.forEach((n=>this.executeBindingsFuncVisit(n,t,e,1,r,i,s,h))):n.forEach((n=>this.buildInsertFuncVisit(n,t,e,1,r,i,s,h))):a?this.executeBindingsFuncVisit(n,t,e,0,r,i,s,h):this.buildInsertFuncVisit(n,t,e,0,r,i,s,h),t.push("if($funcElement){\n"),t.push("    if(!$funcElement.bindArray)$funcElement.bindArray=[];\n"),t.push("    $funcElement.bindArray[$context.$index] = renderedElements;\n"),t.push("}\n"),t}executeBindingsFuncVisit(t,e,n,r,i,s,h,a){if(1==t.nodeType)t.getAttribute("bind")}buildInsertFuncVisit(t,e,n,r,i,s,h,a){var o=!1;if(1==t.nodeType){if(e.push(r>e.maxDepth?"var ":"","n",r," = document.createElement('",t.nodeName,"');\n"),r>e.maxDepth&&(e.maxDepth=r),t.hasAttributes()){var u=t.attributes;for(let b=u.length-1;b>=0;b--){const m=u[b].name;var c=u[b].value;if("bind"==m){if(-1==c.indexOf(":"))c="{"+this.getDefaultBinder(t)+":"+c+"}";c.startsWith("{")||(c="{"+c+"}");var l={$data:new Proxy((function(){}),new FunctionTester),$index:()=>0},d=new Function("$context","with($context){with($data){ return "+c+"}}").call(l.$data,l);for(const t in d)c=c.replace(new RegExp(t+"s*:"),t+": ()=> ");o=Object.keys(d).some((t=>Object.keys(this.subBinders).indexOf(t)>=0));var f=i;o&&(this.bindObjectCount++,f=this.bindObjectCount,n[this.bindObjectCount]={code:["\n    $mb.bindObjects[",this.bindObjectCount,"] = ",this.k(n,t.childNodes,this.bindObjectCount,s,h,!0),";\n"]}),e.push("{");var v=0,p=0;if(s)p=(s.substr(0,s.indexOf(t.outerHTML)).match(/\n/g)||[]).length,v=e.join("").match(/\n/g).length+3,a?(null==h.offset[i]&&(h.offset[i]=[]),h.offset[i][v]=p):h.root[v]=p;e.push("$mb.executeBinding(n",r,", $context, (function(){with($context){with($data??{}){\nreturn ",c,"// line: ",v,", offset: ",a,", src: ",p,"\n}}}).call($context.$data), ",f,");\n"),e.push("}")}else e.push("n",r,".setAttribute('",m,"', '",c,"');\n")}}e.push("n",r-1,".appendChild(n",r,");\n\n"),r-1==0&&e.push("renderedElements.push(n",r,");\n\n")}else 3==t.nodeType&&(e.push("t = document.createTextNode(`",t.nodeValue.replace(/\\/g,"\\\\"),"`);\n"),e.push("n",r-1,".appendChild(t);\n\n"),r-1==0&&e.push("renderedElements.push(t);\n\n"));o||t.childNodes.forEach((t=>this.buildInsertFuncVisit(t,e,n,r+1,i,s,h,a)))}getDefaultBinder(t){for(let e=0;e<this.defaultBinders.length;e++){const n=this.defaultBinders[e];if(t.matches(n.match))return n.binder}return"text"}}class FunctionTester{has(t,e){return!0}get(t,e,n){return e==Symbol.unscopables?{}:e==Symbol.toPrimitive||"toString"==e?()=>"":n}set(t,e,n,r){}apply(t,e,n){return this}}class MicroBinder extends MicroBinderCore{constructor(){super(),this.funcGen=new FuncGenerator,this.binders={text:(t,e,n)=>this.bind(n,((e,n)=>t.innerText=e),e),html:(t,e,n)=>this.bind(n,((e,n)=>t.innerHTML=e),e),value:(t,e,n)=>{this.bind(n,((e,n)=>t.value=e||""),e),t.addEventListener("change",(t=>this.setValue(e,n,t.target.value)))},textInput:(t,e,n)=>{this.bind(n,((e,n)=>t.value=e||""),e),t.addEventListener("input",(t=>this.setValue(e,n,t.target.value)))},checked:(t,e,n)=>{this.bind(n,((e,n)=>{e?t.setAttribute("checked",""):t.removeAttribute("checked","")}),e),t.addEventListener("change",(t=>this.setValue(e,n,t.target.checked)))},hasFocus:(t,e,n)=>{this.bind(n,((e,n)=>e?t.focus():t.blur()),e),t.addEventListener("focus",(t=>this.setValue(e,n,!0))),t.addEventListener("blur",(t=>this.setValue(e,n,!1)))},css:(t,e,n)=>{var r=n();for(const n in r)this.bind(r[n],((e,r)=>e?t.classList.add(n):t.classList.remove(n)),e)},attr:(t,e,n)=>{var r=n();for(const n in r)this.bind(r[n],((e,r)=>t.setAttribute(n,e)),e)},prop:(t,e,n)=>{var r=n(),i=!1;for(const n in r)this.bind(r[n],((e,r)=>{t.proxy[n]!=e&&(i=!0,t.proxy[n]=e,i=!1)}),e);t.addEventListener("propchange",(t=>{null!=n()[t.name]&&0==i&&this.setValue(e,r[t.name],t.newValue)}))},props:(t,e,n)=>{var r=!1;this.bind(n,((e,n)=>{for(const e in n)this.bind(n,(()=>n[e]),((n,i)=>{t.proxy[e]!=n&&(r=!0,t.proxy[e]=n,r=!1)}))}),e),t.addEventListener("propchange",(t=>{var e=n();null!=e[t.name]&&0==r&&this.setValue(e,(()=>e[t.name]),t.newValue)}))},style:(t,e,n)=>{var r=n();for(const n in r)this.bind(r[n],((e,r)=>t.style[n]=e),e)},visible:(t,e,n)=>this.bind(n,((e,n)=>t.style.display=e?null:"none"),e),click:(t,e,n)=>t.addEventListener("click",(t=>n()(e.$data,t))),enter:(t,e,n)=>{t.addEventListener("keypress",(t=>{13===t.keyCode&&n()(e.$data,t)}))},submit:(t,e,n)=>t.addEventListener("submit",(t=>n()(e.$data,t))),if:(t,e,n,r)=>{t.insertFunc=this.bindObjects[r],t.$context=e,t.L=!1,this.bind(n,((n,r)=>{if(n&&!t.L){var i=document.createDocumentFragment();t.insertFunc.call(e.$data,e,i,t),t.appendChild(i),t.L=!0}else!n&&t.L&&(t.innerHTML="",t.L=!1)}),e)},with:(t,e,n,r)=>{t.insertFunc=this.bindObjects[r],t.$context=e,this.bind(n,((n,r)=>{t.innerHTML="";var i=document.createDocumentFragment();t.insertFunc.call(n,new BindingContext$1(this,n,0,e),i,t),t.appendChild(i)}),e)},foreach:(t,e,n,r)=>{t.insertFunc=this.bindObjects[r],t.$context=e;var i=n.call(e.$data);t.$array=i,t.bindArray=[],i.proxyHandler._.push(t);var s=document.createDocumentFragment();for(let n=0;n<i.length;n++){const r=i[n];null==i.childContexts[n]&&(i.childContexts[n]=new BindingContext$1(this,r,n,e)),t.insertFunc.call(r,i.childContexts[n],s,t)}t.appendChild(s)},selectedOptions:(t,e,n)=>{this.bind(n,((e,n)=>{var r=e.map((t=>t.toString()));Array.from(t.options).forEach((t=>t.selected=r.indexOf(t.value)>-1))}),e),t.addEventListener("change",(t=>{var r=Array.from(t.target.selectedOptions).map((t=>t.value));this.setValue(e,n,r)}))},event:(t,e,n)=>{var r=n();for(const n in r){const i=r[n];t.addEventListener(n,(n=>i.call(e,t)))}},enable:(t,e,n)=>{this.bind(n,((e,n)=>e?t.removeAttribute("disabled"):t.setAttribute("disabled","")),e)},disable:(t,e,n)=>{this.bind(n,((e,n)=>e?t.setAttribute("disabled",""):t.removeAttribute("disabled")),e)}}}applyBindings(t,e,n){return this.build(n).then((n=>this.run(t,e||document.body,n)))}build(t){return new Promise(((e,n)=>{this.funcGen.generateRootInsertFunc(t).then((t=>{e(t)})).catch((t=>n(t)))}))}run(t,e,n){var r=this.wrap(t),i=new BindingContext$1(this,r);return n.call(this,i,e),r}executeBinding(t,e,n,r){var i=!1;for(var s in n)i=this.binders[s](t,e,n[s],r)|i;return i}setValue(t,e,n){this.A=!0,this.j=[];e.call(t.$data);this.A=!1,this.j.length>0&&this.j.pop()(n)}}var mb_debug=new MicroBinder;export default mb_debug;