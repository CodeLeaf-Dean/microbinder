class ObjectHandler{constructor(e){this.mb=e,this._handler=this,this._childProxies={},this._subscribers={},this.parentProxy=null}_subscribe(e,t,n,i){if("constructor"==e)return null;null==this._subscribers[e]&&(this._subscribers[e]=[]);var r=this._subscribers[e];if(!Array.isArray(r))return null;var s={_eventFunc:t,_subscription:()=>this._subscribers[e],_triggerFunc:n,_bindingId:i};return r.push(s),s}_notifySubscribers(e,t,n,i,r,s){if(null!=this._subscribers[e])for(var a=this._subscribers[e].length-1;a>=0;a--)this._subscribers[e][a]._eventFunc(n,t,i,r,s)}get(e,t,n){if("_proxyHandler"===t)return this;if("_parentProxy"===t)return this.parentProxy;if("_isProxy"===t)return!0;if("_proxyObject"===t)return e;if("_subscribe"===t)return this._subscribe.bind(this);var i=Reflect.get(e,t,n);if(this.mb._calculatingDependancies&&(this.mb._calculatedDependancies.find((e=>e.handler==this&&e.prop==t))||this.mb._calculatedDependancies.push({handler:this,prop:t})),this.mb._settingValue&&this.mb._setStack.push((e=>n[t]=e)),null!=i&&"object"==typeof i){if(null==this._childProxies[t]){var r=this.mb.wrap(i);r._proxyHandler.parentProxy=n,r._proxyHandler.parentProp=t,this._childProxies[t]=r}return this._childProxies[t]}return i}set(e,t,n,i){var r=!1;null!=n&&n._isProxy&&(this._childProxies[t]=n,n=n._proxyObject,r=!0);var s=e[t],a=Reflect.set(e,t,n,i);if("object"==typeof n&&!r){var l=this._childProxies[t];if(delete this._childProxies[t],Array.isArray(n)){var c=i[t];l&&(l.length=0,c._proxyHandler._bindElements=l._proxyHandler._bindElements),c._proxyHandler._handleSplice(0,0,n.length,c)}}return this._notifySubscribers(t,s,n),a}}class DateHandler extends ObjectHandler{constructor(e){super(e)}get(e,t,n){var i=super.get(e,t,n);return"function"==typeof i?function(t){var n=new Date(e.valueOf()),r=i.apply(e,arguments);return e!=n&&this.parentProxy._proxyHandler._notifySubscribers(this.parentProp,n,e),r}.bind(this):i}set(e,t,n,i){var r=this.mb._settingValue;this.mb._settingValue=!1;var s=super.set(e,t,n,i);return this.mb._settingValue=r,s}}class BindingContext{constructor(e,t,n,i){this.mb=e,this.$data=t,this.$parentContext=i,this._proxy=new Proxy({$index:n},new ObjectHandler(e)),this.bindings=[]}get $parent(){return this.$parentContext.$data}get $index(){return this.mb._calculatingDependancies&&this.mb._calculatedDependancies.push({handler:this._proxy.proxyHandler,prop:"$index"}),this._proxy.$index}set $index(e){this._proxy.$index=e}bind(e,t,n,i,r,s,a){var l=this.mb.bind(e,t,n,i,r,s,a);return this.bindings.push(l),l}createSiblingContext(){return new BindingContext(this.mb,this.$data,this.$index,this.$parentContext)}createChildContext(e,t){return new BindingContext(this.mb,e,t,this)}getPreviousElement(e){if(e.getPreviousSibling){var t=e.getPreviousSibling();if(t&&t.getPreviousSibling){if(t.bindArray&&0!=t.bindArray.length&&0!=t.bindArray[t.bindArray.length-1].length){var n=t.bindArray[t.bindArray.length-1];return n[n.length-1]}return this.getPreviousElement(t)}return t}}commitElement(){if(this.element.getPreviousSibling){var e=this.getPreviousElement(this.element);if(null==e)for(let e=this.element.children.length-1;e>=0;e--)this.element.parent.insertAdjacentElement("afterbegin",this.element.children[e]);else e.after(this.element)}}clearElement(e){if(this.element instanceof DocumentFragment){var t=this.element.bindArray[e];this.clearBindArray(t)}else this.element.innerHTML=""}clearBindArray(e){for(let n=0;n<e.length;n++)if(e[n]instanceof DocumentFragment){e[n].$context.clearBindings();var t=e[n].bindArray;for(let e=0;e<t.length;e++)this.clearBindArray(t[e])}else e[n].remove();e.length=0}clearBindings(){this.bindings.forEach((e=>{e.unbind()})),this.bindings=[]}}class ArrayHandler extends ObjectHandler{constructor(e,t,n){super(e),this._childProxies=[],this._childContexts=[],this._bindElements=[]}_handleSplice(e,t,n,i){var r=[];r[0]=e,r[1]=t;for(let e=0;e<n;e++)r[e+2]=null;Array.prototype.splice.apply(this._childProxies,r),this.parentProxy._proxyHandler._notifySubscribers(this.parentProp,this.parentProxy,this.parentProxy,e,t,n)}get(e,t,n){var i=super.get(e,t,n);return"childContexts"===t?this._childContexts:"function"==typeof i?"splice"===t?function(t){var i=arguments[0];i>e.length&&(i=e.length),i<-e.length&&(i=0),i<0&&(i=e.length+i+1);var r=1==arguments.length?e.length-i:arguments[1];r>e.length-i&&(r=e.length-i);var s=Array.prototype.splice.apply(e,arguments);return this._handleSplice(i,r,arguments.length-2,n),s}.bind(this):"push"===t?function(t){var i=e.length,r=Array.prototype.push.apply(e,arguments);return this._handleSplice(i,0,arguments.length,n),r}.bind(this):"pop"===t?function(){if(0!=e.length){var t=e.length,i=Array.prototype.pop.apply(e,arguments);return this._handleSplice(t-1,1,0,n),i}}.bind(this):"shift"===t?function(){if(0!=e.length){var t=Array.prototype.shift.apply(e,arguments);return this._handleSplice(0,1,0,n),t}}.bind(this):"unshift"===t?function(t){var i=Array.prototype.unshift.apply(e,arguments);return this._handleSplice(0,0,1,n),i}.bind(this):"reverse"===t||"sort"==t?function(i){var r=Array.prototype[t].apply(e,arguments);return this._handleSplice(0,e.length,e.length,n),r}.bind(this):"fill"===t?function(t){var i=arguments[1]||0,r=arguments[2]||e.length;i<0&&(i=ob.length+i),r<0&&(r=ob.length+r);var s=Array.prototype.fill.apply(e,arguments);return this._handleSplice(i,r,r-i,n),s}.bind(this):"indexOf"===t?function(t){arguments[0]=this.mb.unwrap(arguments[0]);var n=Array.prototype.indexOf.apply(e,arguments);return n}.bind(this):i.bind(n):i}set(e,t,n,i){var r=e.length,s=Reflect.set(e,t,n,i);return"length"===t?r>n&&this._handleSplice(n,r-n):e.length===r?this._handleSplice(parseInt(t),1,1,e):this._handleSplice(parseInt(t),0,1,e),s}}class MicroBinderCore{constructor(){this._nextBindingId=1,this._bindings={},this._calculatingDependancies=!1,this._calculatedDependancies=[],this.bindObjects=[],this.bindObjectCount=-1}wrap(e){if(e._isProxy)return e;if(null!=e.___proxy)return e.___proxy;var t="[object Date]"===Object.prototype.toString.call(e)?new DateHandler(this):Array.isArray(e)?new ArrayHandler(this,null,e):new ObjectHandler(this),n=new Proxy(e,t);return e.___proxy=n,n}unwrap(e){return e._isProxy?e._proxyObject:e}bind(e,t,n,i,r,s,a,l){this._calculatingDependancies=!0,this._calculatedDependancies=[];var c=e.call(null==n?null:n.$data);this._calculatingDependancies=!1;var o=l;return this._calculatedDependancies.length>0&&(null==l&&(o=this._nextBindingId++),this._bindings[o]=[],this._calculatedDependancies.forEach((i=>{if(i.handler){var r=i.handler._subscribe(i.prop,((i,r,s,a,l)=>{this._bindings[o].forEach((e=>e._subscription().splice(e._subscription().indexOf(e),1))),delete this._bindings[o],this.bind(e,t,n,r,s,a,l,o)}),e,o);r&&this._bindings[o].push(r)}}))),t(c,i,r,s,a),{unbind:()=>{this._calculatedDependancies.length>0&&this._bindings[o]&&(this._bindings[o].forEach((e=>e._subscription().splice(e._subscription().indexOf(e),1))),delete this._bindings[o])}}}computed(e,t){var n=this,i=n.wrap(t),r=n.wrap({value:void 0});return n.bind(e.bind(i),function(e){r.value!=e&&(r.value=e)}.bind(i)),function(){return r.value}}}class FuncGenerator{constructor(e){this.defaultBinders=[{match:"input[type=text]",binder:"textInput"},{match:"ul",binder:"foreach"},{match:"button",binder:"click"}],this.mb=e}generateRootInsertFunc(e){return new Promise(((t,n)=>{var i=null,r="unnamed-template";if("string"==typeof e){var s=document.getElementById(e);if(null!=s){if("LINK"==s.nodeName){r=s.href;var a=new XMLHttpRequest;return a.open("GET",s.href),a.onreadystatechange=function(){a.readyState===XMLHttpRequest.DONE&&200===a.status&&t(this.buildInsertFuncWithSourceMap(a.responseText,r))}.bind(this),void a.send()}r=e,i=s.content?s.content.cloneNode(!0):document.createRange().createContextualFragment(s.innerHTML)}else{var l=document.createElement("template");l.innerHTML=e,i=l.content}}else i=e;t(null==i?this.buildInsertFuncWithSourceMap(document.body.childNodes,r,!0):this.buildInsertFuncWithSourceMap(i,r))}))}buildInsertFuncWithSourceMap(e,t,n){var i,r={root:[],offset:[]};if("[object NodeList]"===e.toString())i=Array.prototype.reduce.call(e,(function(e,t){return e+(t.outerHTML||t.nodeValue)}),"");else if("string"==typeof e){var s=document.createElement("template");s.innerHTML=e,e=s.content,i=s.innerHTML}else{var a=document.createElement("div");a.appendChild(e.cloneNode(!0)),i=a.innerHTML}var l=[],c=[];this.buildInsertFuncBody(l,c,e,0,i,r,n);var o=l.join("").match(/\n/g).length+3;r.root.length=o;for(let e=0;e<c.length;e++){const t=c[e];l.push("// Offset: ",o),null==r.offset[e]&&(r.offset[e]=[]),r.offset[e].length=(t.code.join("").match(/\n/g)||[]).length,o+=r.offset[e].length,l=l.concat(t.code)}l.push("\n");const h=15,u=31,d=32;function p(e){return e.map(b).map(f).join("")}function b(e){if(0===e)return[0];let t=Math.abs(e);const n=[];for(;t>0;){let i=0;0===n.length?(i=e<0?1:0,i|=(t&h)<<1,t>>>=4):(i=t&u,t>>>=5),t>0&&(i|=d),n.push(i)}return n}function f(e){return e.map((e=>"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[e])).join("")}var m=0;for(let e=0;e<r.root.length;e++){const t=r.root[e];if(null!=t)p([0,0,g=t-m,0]),m+=g;";"}for(let e=0;e<r.offset.length;e++){const t=r.offset[e];for(let e=0;e<t.length;e++){const n=t[e];var g;if(null!=n)p([0,0,g=n-m,0]),m+=g;";"}}return new Function("$context,n0,$funcElement",l.join(""))}buildInsertFuncBody(e,t,n,i,r,s,a,l){return e.maxDepth=0,e.push("\nvar $mb = $context.mb;\n"),e.push("\nvar t = null;\n"),e.push("\nvar prev = null;\n"),e.push("\nvar $bindingContext = null;\n"),e.push("var renderedElements = [];\n"),"[object NodeList]"===n.toString()?l?n.forEach((n=>this.executeBindingsFuncVisit(n,e,t,1,i,r,s,a))):n.forEach((n=>this.buildInsertFuncVisit(n,e,t,1,i,r,s,a))):l?this.executeBindingsFuncVisit(n,e,t,0,i,r,s,a):this.buildInsertFuncVisit(n,e,t,0,i,r,s,a),e.push("if($funcElement){\n"),e.push("    if(!$funcElement.bindArray)$funcElement.bindArray=[];\n"),e.push("    $funcElement.bindArray[$context.$index || 0] = renderedElements;\n"),e.push("}\n"),e}buildInsertFunc(e,t,n,i,r,s){var a=[];return this.buildInsertFuncBody(a,e,t,n,i,r,s),new Function("$context,n0,$funcElement",a.join(""))}executeBindingsFuncVisit(e,t,n,i,r,s,a,l){if(1==e.nodeType)e.getAttribute("bind")}buildInsertFuncVisit(e,t,n,i,r,s,a,l){var c=!1;if(1==e.nodeType){if("VIRTUAL"==e.nodeName?(t.push("prev = ","n",i,";\n"),t.push(i>t.maxDepth?"var ":"","n",i," = document.createDocumentFragment();\n"),t.push("n",i,".prev = prev;\n"),t.push("n",i,".parent = ","n",i-1,";\n"),t.push("n",i,".getPreviousSibling = function(){return this.prev};\n")):t.push(i>t.maxDepth?"var ":"","n",i," = document.createElement('",e.nodeName,"');\n"),i>t.maxDepth&&(t.maxDepth=i),e.hasAttributes()){var o=e.attributes;for(let m=o.length-1;m>=0;m--){const g=o[m].name;var h=o[m].value;if("bind"==g){if(-1==h.indexOf(":"))h="{"+this.getDefaultBinder(e)+":"+h+"}";h.startsWith("{")||(h="{"+h+"}");var u={$data:new FunctionTester,$index:()=>0},d=new Function("$context","with($context){with($data){ return "+h+"}}").call(u.$data,u);for(const e in d)h=h.replace(new RegExp(e+"s*:"),e+": ()=> ");c=Object.keys(d).some((e=>Object.keys(this.mb.subBinders).indexOf(e)>=0));var p=r;c&&(this.mb.bindObjects.push(this.buildInsertFunc(n,e.childNodes,this.mb.bindObjects.length+1)),this.mb.bindObjectCount++,p=this.mb.bindObjectCount,n[p]={code:["\n    $mb.bindObjects[",this.mb.bindObjectCount,"] = ",this.buildInsertFunc(n,e.childNodes,this.mb.bindObjectCount,s,a,!0),";\n"]}),t.push("{");var b=0,f=0;if(s)f=(s.substr(0,s.indexOf(e.outerHTML)).match(/\n/g)||[]).length,b=t.join("").match(/\n/g).length+3,l?(null==a.offset[r]&&(a.offset[r]=[]),a.offset[r][b]=f):a.root[b]=f;t.push("$bindingContext = $context.createSiblingContext();\n"),t.push("$mb.executeBinding(n",i,", $bindingContext, (function(){with($bindingContext){with($data??{}){\nreturn ",h,"// line: ",b,", offset: ",l,", src: ",f,"\n}}}).call($bindingContext.$data), ",p,");\n"),e.nodeName,t.push("}\n")}else"class"==g?t.push("n",i,".classList.add('",h,"');\n"):t.push("n",i,".setAttribute('",g,"', '",h,"');\n")}}t.push("n",i-1,".appendChild(n",i,");\n\n"),i-1==0&&t.push("renderedElements.push(n",i,");\n\n")}else 3==e.nodeType&&(t.push("t = document.createTextNode(`",e.nodeValue.replace(/\\/g,"\\\\"),"`);\n"),t.push("n",i-1,".appendChild(t);\n\n"),i-1==0&&t.push("renderedElements.push(t);\n\n"));c||e.childNodes.forEach((e=>this.buildInsertFuncVisit(e,t,n,i+1,r,s,a,l)))}getDefaultBinder(e){for(let t=0;t<this.defaultBinders.length;t++){const n=this.defaultBinders[t];if(e.matches(n.match))return n.binder}return"text"}}function FunctionTester(){return this.has=function(e,t){return!0},this.get=function(e,t,n){return t==Symbol.unscopables?{}:t==Symbol.toPrimitive||"toString"==t?()=>"":new FunctionTester},this.set=function(e,t,n,i){},this.apply=function(e,t,n){return new FunctionTester},new Proxy((function(){}),this)}function ForBinder(e,t){e.bind(t,((t,n)=>{var i=e.element,r=document.createDocumentFragment(),s=t-(n||0);if(s>0){for(let t=0;t<s;t++)e.insertFunc.call(this,e.createChildContext(e.$data,t+(n||0)),r,i);if(null==n)i.appendChild(r);else{var a=i.bindArray[n-1];a[a.length-1].after(r)}}if(s<0)for(let i=n-1;i>=t;i--)e.clearElement(i)}),e)}function ForEachBinder(e,t){e.bind(t,((t,n,i,r,s)=>{var a=e.element;if(null==n){var l=document.createDocumentFragment();for(let n=0;n<t.length;n++){const i=t[n];e.insertFunc.call(this,e.createChildContext(i,n),l,a)}a.appendChild(l),e.commitElement()}if(r>0){for(let t=0;t<r;t++)e.clearElement(i+t);var c=[];c[0]=i,c[1]=r;for(let e=0;e<s;e++)c[e+2]=[];Array.prototype.splice.apply(a.bindArray,c)}if(s>0){l=document.createDocumentFragment();for(let n=0;n<s;n++){const r=t[i+n];e.insertFunc.call(this,e.createChildContext(r,i+n),l,a)}var o=a.bindArray[i-1];o[o.length-1].after(l)}}),e)}function ComponentBinder(e,t,n,i){var r=n(),s=t.mb.components[r.name];e.$context=t,e.insertFunc=s.insertFunc;var a=document.createDocumentFragment(),l=null==s.viewModel?t.$data:new s.viewModel(t.mb,r.params);l=t.mb.wrap(l);var c=new BindingContext(t.mb,l,0,t);e.insertFunc.call(l,c,a,e),e.appendChild(a)}function IfBinder(e,t){e._if=!1,e.bind(t,((t,n)=>{if(t&&!e._if){var i=document.createDocumentFragment();e.insertFunc.call(e.$data,e,i,e.element),e.element.appendChild(i),e.commitElement(),e._if=!0}else!t&&e._if&&(e.clearElement(0),e._if=!1)}))}class MicroBinder extends MicroBinderCore{constructor(){super();var e=this;this.components={register:function(t,n){return this[t]=n,this[t].insertFunc=e.build(n.template).then((e=>{this[t].insertFunc=e})),this[t].insertFunc}},this.funcGen=new FuncGenerator(this),this.binders={text:(e,t,n)=>this.bind(n,((t,n)=>e.innerText=t),t),html:(e,t,n)=>this.bind(n,((t,n)=>e.innerHTML=t),t),value:(e,t,n)=>{this.bind(n,((t,n)=>e.value=t||""),t),e.addEventListener("change",(e=>this.setValue(t,n,e.target.value)))},textInput:(e,t,n)=>{this.bind(n,((t,n)=>e.value=t||""),t),e.addEventListener("input",(e=>this.setValue(t,n,e.target.value)))},checked:(e,t,n)=>{this.bind(n,((t,n)=>{t?e.setAttribute("checked",""):e.removeAttribute("checked","")}),t),e.addEventListener("change",(e=>this.setValue(t,n,e.target.checked)))},hasFocus:(e,t,n)=>{this.bind(n,((t,n)=>t?e.focus():e.blur()),t),e.addEventListener("focus",(e=>this.setValue(t,n,!0))),e.addEventListener("blur",(e=>this.setValue(t,n,!1)))},css:(e,t,n)=>{var i=n();if("string"==typeof i)this.bind(n,((t,n)=>{"string"==typeof n&&n.split(" ").forEach((t=>{""!=t&&e.classList.remove(t)})),t.split(" ").forEach((t=>{""!=t&&e.classList.add(t)}))}),t);else for(const n in i)this.bind(i[n],((t,i)=>t?e.classList.add(n):e.classList.remove(n)),t)},attr:(e,t,n)=>{var i=n();for(const n in i)this.bind(i[n],((t,i)=>e.setAttribute(n,t)),t)},prop:(e,t,n)=>{var i=n(),r=!1;for(const n in i)this.bind(i[n],((t,i)=>{e.proxy[n]!=t&&(r=!0,e.proxy[n]=t,r=!1)}),t);e.addEventListener("propchange",(e=>{null!=n()[e.name]&&0==r&&this.setValue(t,i[e.name],e.newValue)}))},props:(e,t,n)=>{var i=!1;this.bind(n,((t,n)=>{for(const t in n)this.bind(n,(()=>n[t]),((n,r)=>{e.proxy[t]!=n&&(i=!0,e.proxy[t]=n,i=!1)}))}),t),e.addEventListener("propchange",(e=>{var t=n();null!=t[e.name]&&0==i&&this.setValue(t,(()=>t[e.name]),e.newValue)}))},style:(e,t,n)=>{var i=n();for(const n in i)this.bind(i[n],((t,i)=>e.style[n]=t),t)},visible:(e,t,n)=>this.bind(n,((t,n)=>e.style.display=t?null:"none"),t),click:(e,t,n)=>e.addEventListener("click",(e=>n().call(t.$data,t.$data,e))),enter:(e,t,n)=>{e.addEventListener("keypress",(e=>{13===e.keyCode&&n()(t.$data,e)}))},submit:(e,t,n)=>e.addEventListener("submit",(e=>n()(t.$data,e))),if:IfBinder,with:(e,t,n,i)=>{e.insertFunc=this.funcGen.bindObjects[i],e.$context=t,this.bind(n,((n,i)=>{e.innerHTML="";var r=document.createDocumentFragment();e.insertFunc.call(n,new BindingContext(this,n,0,t),r,e),e.appendChild(r)}),t)},for:ForBinder,foreach:ForEachBinder,component:ComponentBinder,selectedOptions:(e,t,n)=>{this.bind(n,((t,n)=>{var i=t.map((e=>e.toString()));Array.from(e.options).forEach((e=>e.selected=i.indexOf(e.value)>-1))}),t),e.addEventListener("change",(e=>{var i=Array.from(e.target.selectedOptions).map((e=>e.value));this.setValue(t,n,i)}))},event:(e,t,n)=>{var i=n();for(const n in i){const r=i[n];e.addEventListener(n,(n=>r.call(t.$data,e,n)))}},enable:(e,t,n)=>{this.bind(n,((t,n)=>t?e.removeAttribute("disabled"):e.setAttribute("disabled","")),t)},disable:(e,t,n)=>{this.bind(n,((t,n)=>t?e.setAttribute("disabled",""):e.removeAttribute("disabled")),t)}},this.subBinders={if:1,with:1,foreach:1,for:1},this.bindObjects=[],this.bindObjectCount=-1}applyBindings(e,t,n){return this.build(n).then((n=>this.run(e,t||document.body,n)))}build(e){return new Promise(((t,n)=>{this.funcGen.generateRootInsertFunc(e).then((e=>{t(e)})).catch((e=>n(e)))}))}run(e,t,n){var i=this.wrap(e),r=new BindingContext(this,i);return n.call(this,r,t),i}executeBinding(e,t,n,i){e.$context=t,t.element=e,t.insertFunc=this.bindObjects[i];var r=!1;for(var s in n)r="foreach"==s||"for"==s||"if"==s?this.binders[s](t,n[s])|r:this.binders[s](e,t,n[s],i)|r;return r}setValue(e,t,n){this._settingValue=!0,this._setStack=[];t.call(e.$data);this._settingValue=!1,this._setStack.length>0&&this._setStack.pop()(n)}}export default MicroBinder;