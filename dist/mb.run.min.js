class ObjectHandler{constructor(e){this.mb=e,this._handler=this,this._childProxies={},this._subscribers={},this.parentProxy=null}_subscribe(e,t,n,i){if("constructor"==e)return null;null==this._subscribers[e]&&(this._subscribers[e]=[]);var r=this._subscribers[e];if(!Array.isArray(r))return null;var s={_eventFunc:t,_subscription:()=>this._subscribers[e],_triggerFunc:n,_bindingId:i};return r.push(s),s}_notifySubscribers(e,t,n,i,r,s){if(null!=this._subscribers[e])for(var a=this._subscribers[e].length-1;a>=0;a--)this._subscribers[e][a]._eventFunc(n,t,i,r,s)}get(e,t,n){if("_proxyHandler"===t)return this;if("_parentProxy"===t)return this.parentProxy;if("_isProxy"===t)return!0;if("_proxyObject"===t)return e;if("_subscribe"===t)return this._subscribe.bind(this);var i=Reflect.get(e,t,n);if(this.mb._calculatingDependancies&&(this.mb._calculatedDependancies.find((e=>e.handler==this&&e.prop==t))||this.mb._calculatedDependancies.push({handler:this,prop:t})),this.mb._settingValue&&this.mb._setStack.push((e=>n[t]=e)),null!=i&&"object"==typeof i){if(null==this._childProxies[t]){var r=this.mb.wrap(i);r._proxyHandler.parentProxy=n,r._proxyHandler.parentProp=t,this._childProxies[t]=r}return this._childProxies[t]}return i}set(e,t,n,i){var r=!1;null!=n&&n._isProxy&&(this._childProxies[t]=n,n=n._proxyObject,r=!0);var s=e[t],a=Reflect.set(e,t,n,i);if("object"==typeof n&&!r){var l=this._childProxies[t];if(delete this._childProxies[t],Array.isArray(n)){var h=i[t];l&&(l.length=0,h._proxyHandler._bindElements=l._proxyHandler._bindElements),h._proxyHandler._handleSplice(0,0,n.length,h)}}return this._notifySubscribers(t,s,n),a}}class DateHandler extends ObjectHandler{constructor(e){super(e)}get(e,t,n){var i=super.get(e,t,n);return"function"==typeof i?function(t){var n=new Date(e.valueOf()),r=i.apply(e,arguments);return e!=n&&this.parentProxy._proxyHandler._notifySubscribers(this.parentProp,n,e),r}.bind(this):i}set(e,t,n,i){var r=this.mb._settingValue;this.mb._settingValue=!1;var s=super.set(e,t,n,i);return this.mb._settingValue=r,s}}class BindingContext{constructor(e,t,n,i){this.mb=e,this.$data=t,this.$parentContext=i,this._proxy=new Proxy({$index:n},new ObjectHandler(e)),this.bindings=[]}get $parent(){return this.$parentContext.$data}get $index(){return this.mb._calculatingDependancies&&this.mb._calculatedDependancies.push({handler:this._proxy.proxyHandler,prop:"$index"}),this._proxy.$index}set $index(e){this._proxy.$index=e}bind(e,t,n,i,r,s,a){var l=this.mb.bind(e,t,n,i,r,s,a);return this.bindings.push(l),l}createSiblingContext(){return new BindingContext(this.mb,this.$data,this.$index,this.$parentContext)}createChildContext(e,t){return new BindingContext(this.mb,e,t,this)}getPreviousElement(e){if(e.getPreviousSibling){var t=e.getPreviousSibling();if(t&&t.getPreviousSibling){if(t.bindArray&&0!=t.bindArray.length&&0!=t.bindArray[t.bindArray.length-1].length){var n=t.bindArray[t.bindArray.length-1];return n[n.length-1]}return this.getPreviousElement(t)}return t}}commitElement(){if(this.element.getPreviousSibling){var e=this.getPreviousElement(this.element);if(null==e)for(let e=this.element.children.length-1;e>=0;e--)this.element.parent.insertAdjacentElement("afterbegin",this.element.children[e]);else e.after(this.element)}}clearElement(e){if(this.element instanceof DocumentFragment){var t=this.element.bindArray[e];this.clearBindArray(t)}else this.element.innerHTML=""}clearBindArray(e){for(let n=0;n<e.length;n++)if(e[n]instanceof DocumentFragment){e[n].$context.clearBindings();var t=e[n].bindArray;for(let e=0;e<t.length;e++)this.clearBindArray(t[e])}else e[n].remove();e.length=0}clearBindings(){this.bindings.forEach((e=>{e.unbind()})),this.bindings=[]}}class ArrayHandler extends ObjectHandler{constructor(e,t,n){super(e),this._childProxies=[],this._childContexts=[],this._bindElements=[]}_handleSplice(e,t,n,i){var r=[];r[0]=e,r[1]=t;for(let e=0;e<n;e++)r[e+2]=null;Array.prototype.splice.apply(this._childProxies,r),this.parentProxy._proxyHandler._notifySubscribers(this.parentProp,this.parentProxy,this.parentProxy,e,t,n)}get(e,t,n){var i=super.get(e,t,n);return"childContexts"===t?this._childContexts:"function"==typeof i?"splice"===t?function(t){var i=arguments[0];i>e.length&&(i=e.length),i<-e.length&&(i=0),i<0&&(i=e.length+i+1);var r=1==arguments.length?e.length-i:arguments[1];r>e.length-i&&(r=e.length-i);var s=Array.prototype.splice.apply(e,arguments);return this._handleSplice(i,r,arguments.length-2,n),s}.bind(this):"push"===t?function(t){var i=e.length,r=Array.prototype.push.apply(e,arguments);return this._handleSplice(i,0,arguments.length,n),r}.bind(this):"pop"===t?function(){if(0!=e.length){var t=e.length,i=Array.prototype.pop.apply(e,arguments);return this._handleSplice(t-1,1,0,n),i}}.bind(this):"shift"===t?function(){if(0!=e.length){var t=Array.prototype.shift.apply(e,arguments);return this._handleSplice(0,1,0,n),t}}.bind(this):"unshift"===t?function(t){var i=Array.prototype.unshift.apply(e,arguments);return this._handleSplice(0,0,1,n),i}.bind(this):"reverse"===t||"sort"==t?function(i){var r=Array.prototype[t].apply(e,arguments);return this._handleSplice(0,e.length,e.length,n),r}.bind(this):"fill"===t?function(t){var i=arguments[1]||0,r=arguments[2]||e.length;i<0&&(i=ob.length+i),r<0&&(r=ob.length+r);var s=Array.prototype.fill.apply(e,arguments);return this._handleSplice(i,r,r-i,n),s}.bind(this):"indexOf"===t?function(t){arguments[0]=this.mb.unwrap(arguments[0]);var n=Array.prototype.indexOf.apply(e,arguments);return n}.bind(this):i.bind(n):i}set(e,t,n,i){var r=e.length,s=Reflect.set(e,t,n,i);return"length"===t?r>n&&this._handleSplice(n,r-n):e.length===r?this._handleSplice(parseInt(t),1,1,e):this._handleSplice(parseInt(t),0,1,e),s}}class MicroBinderCore{constructor(){this._nextBindingId=1,this._bindings={},this._calculatingDependancies=!1,this._calculatedDependancies=[],this.bindObjects=[],this.bindObjectCount=-1}wrap(e){if(e._isProxy)return e;if(null!=e.___proxy)return e.___proxy;var t="[object Date]"===Object.prototype.toString.call(e)?new DateHandler(this):Array.isArray(e)?new ArrayHandler(this,null,e):new ObjectHandler(this),n=new Proxy(e,t);return e.___proxy=n,n}unwrap(e){return e._isProxy?e._proxyObject:e}bind(e,t,n,i,r,s,a,l){this._calculatingDependancies=!0,this._calculatedDependancies=[];var h=e.call(null==n?null:n.$data);this._calculatingDependancies=!1;var c=l;return this._calculatedDependancies.length>0&&(null==l&&(c=this._nextBindingId++),this._bindings[c]=[],this._calculatedDependancies.forEach((i=>{if(i.handler){var r=i.handler._subscribe(i.prop,((i,r,s,a,l)=>{this._bindings[c].forEach((e=>e._subscription().splice(e._subscription().indexOf(e),1))),delete this._bindings[c],this.bind(e,t,n,r,s,a,l,c)}),e,c);r&&this._bindings[c].push(r)}}))),t(h,i,r,s,a),{unbind:()=>{this._calculatedDependancies.length>0&&this._bindings[c]&&(this._bindings[c].forEach((e=>e._subscription().splice(e._subscription().indexOf(e),1))),delete this._bindings[c])}}}computed(e,t){var n=this,i=n.wrap(t),r=n.wrap({value:void 0});return n.bind(e.bind(i),function(e){r.value!=e&&(r.value=e)}.bind(i)),function(){return r.value}}}function ForBinder(e,t){e.bind(t,((t,n)=>{var i=e.element,r=document.createDocumentFragment(),s=t-(n||0);if(s>0){for(let t=0;t<s;t++)e.insertFunc.call(this,e.createChildContext(e.$data,t+(n||0)),r,i);if(null==n)i.appendChild(r);else{var a=i.bindArray[n-1];a[a.length-1].after(r)}}if(s<0)for(let i=n-1;i>=t;i--)e.clearElement(i)}),e)}function ForEachBinder(e,t){e.bind(t,((t,n,i,r,s)=>{var a=e.element;if(null==n){var l=document.createDocumentFragment();for(let n=0;n<t.length;n++){const i=t[n];e.insertFunc.call(this,e.createChildContext(i,n),l,a)}a.appendChild(l),e.commitElement()}if(r>0){for(let t=0;t<r;t++)e.clearElement(i+t);var h=[];h[0]=i,h[1]=r;for(let e=0;e<s;e++)h[e+2]=[];Array.prototype.splice.apply(a.bindArray,h)}if(s>0){l=document.createDocumentFragment();for(let n=0;n<s;n++){const r=t[i+n];e.insertFunc.call(this,e.createChildContext(r,i+n),l,a)}var c=a.bindArray[i-1];c[c.length-1].after(l)}}),e)}function ComponentBinder(e,t,n,i){var r=n(),s=t.mb.components[r.name];e.$context=t,e.insertFunc=s.insertFunc;var a=document.createDocumentFragment(),l=null==s.viewModel?t.$data:new s.viewModel(t.mb,r.params);l=t.mb.wrap(l);var h=new BindingContext(t.mb,l,0,t);e.insertFunc.call(l,h,a,e),e.appendChild(a)}function IfBinder(e,t){e._if=!1,e.bind(t,((t,n)=>{if(t&&!e._if){var i=document.createDocumentFragment();e.insertFunc.call(e.$data,e,i,e.element),e.element.appendChild(i),e.commitElement(),e._if=!0}else!t&&e._if&&(e.clearElement(0),e._if=!1)}))}class MicroBinder extends MicroBinderCore{constructor(){super();var e=this;this.components={register:function(t,n){return this[t]=n,this[t].insertFunc=e.build(n.template).then((e=>{this[t].insertFunc=e})),this[t].insertFunc}},this.binders={text:(e,t,n)=>this.bind(n,((t,n)=>e.innerText=t),t),html:(e,t,n)=>this.bind(n,((t,n)=>e.innerHTML=t),t),value:(e,t,n)=>{this.bind(n,((t,n)=>e.value=t||""),t),e.addEventListener("change",(e=>this.setValue(t,n,e.target.value)))},textInput:(e,t,n)=>{this.bind(n,((t,n)=>e.value=t||""),t),e.addEventListener("input",(e=>this.setValue(t,n,e.target.value)))},checked:(e,t,n)=>{this.bind(n,((t,n)=>{t?e.setAttribute("checked",""):e.removeAttribute("checked","")}),t),e.addEventListener("change",(e=>this.setValue(t,n,e.target.checked)))},hasFocus:(e,t,n)=>{this.bind(n,((t,n)=>t?e.focus():e.blur()),t),e.addEventListener("focus",(e=>this.setValue(t,n,!0))),e.addEventListener("blur",(e=>this.setValue(t,n,!1)))},class:(e,t,n)=>{n();this.bind(n,((t,n)=>{"string"==typeof n&&n.split(" ").forEach((t=>{""!=t&&e.classList.remove(t)})),t.split(" ").forEach((t=>{""!=t&&e.classList.add(t)}))}),t)},css:(e,t,n)=>{var i=n();if("string"==typeof i)this.bind(n,((t,n)=>{"string"==typeof n&&n.split(" ").forEach((t=>{""!=t&&e.classList.remove(t)})),t.split(" ").forEach((t=>{""!=t&&e.classList.add(t)}))}),t);else for(const n in i)this.bind(i[n],((t,i)=>t?e.classList.add(n):e.classList.remove(n)),t)},attr:(e,t,n)=>{var i=n();for(const n in i)this.bind(i[n],((t,i)=>e.setAttribute(n,t)),t)},prop:(e,t,n)=>{var i=n(),r=!1;for(const n in i)this.bind(i[n],((t,i)=>{e.proxy[n]!=t&&(r=!0,e.proxy[n]=t,r=!1)}),t);e.addEventListener("propchange",(e=>{null!=n()[e.name]&&0==r&&this.setValue(t,i[e.name],e.newValue)}))},props:(e,t,n)=>{var i=!1;this.bind(n,((t,n)=>{for(const t in n)this.bind(n,(()=>n[t]),((n,r)=>{e.proxy[t]!=n&&(i=!0,e.proxy[t]=n,i=!1)}))}),t),e.addEventListener("propchange",(e=>{var t=n();null!=t[e.name]&&0==i&&this.setValue(t,(()=>t[e.name]),e.newValue)}))},style:(e,t,n)=>{var i=n();for(const n in i)this.bind(i[n],((t,i)=>e.style[n]=t),t)},visible:(e,t,n)=>this.bind(n,((t,n)=>e.style.display=t?null:"none"),t),click:(e,t,n)=>e.addEventListener("click",(e=>n().call(t.$data,t.$data,e))),enter:(e,t,n)=>{e.addEventListener("keypress",(e=>{13===e.keyCode&&n()(t.$data,e)}))},submit:(e,t,n)=>e.addEventListener("submit",(e=>n()(t.$data,e))),if:IfBinder,with:(e,t,n,i)=>{e.insertFunc=this.funcGen.bindObjects[i],e.$context=t,this.bind(n,((n,i)=>{e.innerHTML="";var r=document.createDocumentFragment();e.insertFunc.call(n,new BindingContext(this,n,0,t),r,e),e.appendChild(r)}),t)},for:ForBinder,foreach:ForEachBinder,component:ComponentBinder,selectedOptions:(e,t,n)=>{this.bind(n,((t,n)=>{var i=t.map((e=>e.toString()));Array.from(e.options).forEach((e=>e.selected=i.indexOf(e.value)>-1))}),t),e.addEventListener("change",(e=>{var i=Array.from(e.target.selectedOptions).map((e=>e.value));this.setValue(t,n,i)}))},event:(e,t,n)=>{var i=n();for(const n in i){const r=i[n];e.addEventListener(n,(n=>r.call(t.$data,e,n)))}},enable:(e,t,n)=>{this.bind(n,((t,n)=>t?e.removeAttribute("disabled"):e.setAttribute("disabled","")),t)},disable:(e,t,n)=>{this.bind(n,((t,n)=>t?e.setAttribute("disabled",""):e.removeAttribute("disabled")),t)}},this.subBinders={if:1,with:1,foreach:1,for:1},this.bindObjects=[],this.bindObjectCount=-1}run(e,t,n){var i=this.wrap(e),r=new BindingContext(this,i);return n.call(this,r,t),i}executeBinding(e,t,n,i){e.$context=t,t.element=e,t.insertFunc=this.bindObjects[i];var r=!1;for(var s in n)r="foreach"==s||"for"==s||"if"==s?this.binders[s](t,n[s])|r:this.binders[s](e,t,n[s],i)|r;return r}setValue(e,t,n){this._settingValue=!0,this._setStack=[];t.call(e.$data);this._settingValue=!1,this._setStack.length>0&&this._setStack.pop()(n)}}export default MicroBinder;